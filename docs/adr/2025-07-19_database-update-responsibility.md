# ADR: データベース更新責務の分離

- **Status**: Proposed
- **Date**: 2025-07-19

## Context

本システムは、ユーザーからの直接的なリクエストを処理する.NETバックエンドと、非同期でAIの思考処理を行うPython Azure Functionという、役割の異なる2つのコンポーネントから構成される。両者がデータベース（Neo4j）に書き込みを行うため、どちらがどのようなデータの書き込みに責任を持つかを明確に定義する必要がある。

## Decision

Neo4jデータベースへの書き込み責務を、操作の起因に基づいて以下のように明確に分離する。

- **.NETバックエンドの責務**:
    - **担当する操作**: ユーザー起因の直接的・同期的操作。
    - **具体例**: ユーザーアカウントの作成、キャラクターの新規作成、ユーザー設定の変更など、ユーザーのWeb UI操作に直接応答して完了する必要がある処理。

- **Python Azure Functionの責務**:
    - **担当する操作**: AI起因の間接的・非同期的操作。
    - **具体例**: AIの思考サイクルが完了した結果として生じる、キャラクターの内部状態（感情、欲求など）の更新、新しい投稿（Postノード）の作成、キャラクター間関係性（KNOWSリレーション）の変化など。

## Consequences

- **Positive**:
    - 各コンポーネントの関心事が明確に分離され、コードの見通しが良くなり、保守性が向上する。
    - 同期処理と非同期処理が明確に分かれるため、パフォーマンスのボトルネック特定や、トランザクション管理が容易になる。
    - .NETはユーザー応答性、PythonはAI処理と、それぞれの得意分野に特化できる。
- **Negative**:
    - 一連のビジネスロジックが2つのサービスにまたがって実装される場合があり、全体の流れを追うのが少し複雑になる可能性がある。
    - サービス間の連携（Azure Storage Queueなど）がクリティカルパスとなり、この部分の信頼性担保が重要になる。
