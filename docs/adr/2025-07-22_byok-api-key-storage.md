# ADR: [Backend] [BYOK] Azure Key Vault を使用したAPIキーの安全な保存

- **Status**: Proposed
- **Date**: 2025-07-22

## Context

ユーザーが自身のLLM APIキー（BYOK: Bring Your Own Key）を持ち込む機能を提供するにあたり、これらの機密情報を安全に保存・管理する必要がある。特に、.NETバックエンドがこれらのAPIキーを保存および取得する際のセキュリティと運用効率を考慮する必要がある。

## Decision

ユーザーのLLM APIキーはAzure Key Vaultに安全に保存することとする。

- **保存方法**: .NETバックエンドはAzure Key Vault SDKを使用してAPIキーをKey Vaultに保存する。各APIキーはユーザーIDに紐づけて管理される。
- **取得方法**: .NETバックエンドは必要に応じてKey VaultからAPIキーを取得する。
- **認証**: Azure Key Vaultへのアクセスには、Azure Managed Identityを使用する。これにより、アプリケーションコードや構成ファイルに認証情報を直接含めることなく、セキュアなアクセスを実現する。

## Consequences

- **Positive**:
    - **セキュリティの向上**: 機密性の高いAPIキーを安全なマネージドサービスであるAzure Key Vaultで管理することで、データ漏洩のリスクを大幅に低減できる。
    - **認証情報の分離**: 認証情報がコードベースから完全に分離されるため、セキュリティベストプラクティスに準拠し、コードの保守性が向上する。
    - **運用負荷の軽減**: Azureのマネージドサービスを利用することで、キーのローテーションやアクセス管理などの運用負荷が軽減される。
- **Negative**:
    - **インフラの複雑性**: Azure Key Vaultのセットアップと、アプリケーションからのアクセス権限設定（Managed Identityの構成を含む）が必要となり、初期のインフラ構築がわずかに複雑になる。
    - **開発環境の考慮**: ローカル開発環境でのKey Vaultへのアクセス方法（例: Azure CLIでの認証、開発用サービスプリンシパル）を考慮する必要がある。
    - **コスト**: Azure Key Vaultの利用には、わずかながらコストが発生する可能性がある。
